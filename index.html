<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8">
  <title>Micro:bit -> Video (teplota / světlo)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body { font-family: system-ui, Arial; text-align:center; padding:24px; }
    #status { margin: 12px 0; color:#333; }
    #current { font-weight:700; margin:8px 0; }
    button { padding:10px 16px; font-size:16px; cursor:pointer; }
    .controls {
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:center;
      margin: 16px auto;
      width: 220px; /* vycentruje sloupec tlačítek */
    }
    .videos { margin-top:16px; display:flex; justify-content:center; gap:12px; flex-wrap:wrap; }
    video { width:320px; max-width:45vw; display:none; border-radius:8px; background:#000; }
    #log { margin-top:12px; font-size:13px; color:#555; max-width:800px; margin-left:auto; margin-right:auto; text-align:left; }
    .small { font-size:13px; color:#666; }
  </style>
</head>
<body>
  <h1>Micro:bit -> přehrávač videí</h1>
  <div id="status">Stav: čekám na připojení</div>

  <div class="controls">
    <button id="connectBtn">Připojit Micro:bit</button>
    <button data-cmd="snow">Sněhová vločka (snow)</button>
    <button data-cmd="cloud">Mrak (cloud)</button>
    <button data-cmd="fire">Oheň (fire)</button>
    <button data-cmd="moon">Měsíc (moon)</button>
    <button data-cmd="sun">Slunce (sun)</button>
  </div>

  <div id="current" class="small">Aktuální příkaz: <span id="cmd">—</span></div>

  <div class="videos">
    <video id="video-snow" src="snow.mp4" loop muted playsinline></video>
    <video id="video-cloud" src="cloud.mp4" loop muted playsinline></video>
    <video id="video-fire" src="fire.mp4" loop muted playsinline></video>
    <video id="video-moon" src="moon.mp4" loop muted playsinline></video>
    <video id="video-sun" src="sun.mp4" loop muted playsinline></video>
  </div>

  <div id="log" aria-live="polite"></div>

<script>
const UART_SERVICE = '6e400001-b5a3-f393-e0a9-e50e24dcca9e';
const UART_RX_CHAR = '6e400003-b5a3-f393-e0a9-e50e24dcca9e';

const statusEl = document.getElementById('status');
const logEl = document.getElementById('log');
const cmdEl = document.getElementById('cmd');

const videos = {
  snow: document.getElementById('video-snow'),
  cloud: document.getElementById('video-cloud'),
  fire: document.getElementById('video-fire'),
  moon: document.getElementById('video-moon'),
  sun: document.getElementById('video-sun')
};

let btDevice = null;
let rxChar = null;
let buffer = '';

function log(msg) {
  const now = new Date().toLocaleTimeString();
  logEl.innerHTML = `<div>[${now}] ${msg.replace(/&/g,'&amp;').replace(/</g,'&lt;')}</div>` + logEl.innerHTML;
}

function showVideo(key) {
  if (!videos[key]) { log('Neznámý příkaz: ' + key); return; }
  cmdEl.textContent = key;
  Object.entries(videos).forEach(([k, el]) => {
    if (k === key) {
      el.style.display = 'block';
      el.play().catch(e => log('Play failed: '+e));
    } else {
      el.pause();
      el.currentTime = 0;
      el.style.display = 'none';
    }
  });
  log('Přepnuto na video: ' + key);
}

async function connect() {
  try {
    statusEl.textContent = 'Stav: vyžádání zařízení...';
    btDevice = await navigator.bluetooth.requestDevice({
      acceptAllDevices: true,
      optionalServices: [UART_SERVICE]
    });
    statusEl.textContent = 'Stav: připojuji...';
    const server = await btDevice.gatt.connect();
    const service = await server.getPrimaryService(UART_SERVICE);
    rxChar = await service.getCharacteristic(UART_RX_CHAR);
    await rxChar.startNotifications();
    rxChar.addEventListener('characteristicvaluechanged', handleNotification);
    statusEl.textContent = 'Stav: připojeno — naslouchám UART';
    log('Připojeno k: ' + (btDevice.name || btDevice.id));
    btDevice.addEventListener('gattserverdisconnected', () => {
      statusEl.textContent = 'Stav: odpojeno';
      log('Zařízení odpojeno');
    });
  } catch (err) {
    statusEl.textContent = 'Chyba připojení';
    log('Chyba: ' + err);
  }
}

function handleNotification(e) {
  const text = new TextDecoder().decode(e.target.value);
  buffer += text;
  const parts = buffer.split(/[\r\n]+/);
  buffer = parts.pop() || '';
  for (const p of parts) {
    const token = p.trim().toLowerCase();
    if (!token) continue;
    processToken(token);
  }
  const maybe = buffer.trim().toLowerCase();
  if (maybe && /^(snow|cloud|fire|moon|sun)$/.test(maybe)) {
    processToken(maybe);
    buffer = '';
  }
}

function processToken(token) {
  log('Příchozí token: ' + token);
  switch (token) {
    case 'snow': showVideo('snow'); break;
    case 'cloud': showVideo('cloud'); break;
    case 'fire': showVideo('fire'); break;
    case 'moon': showVideo('moon'); break;
    case 'sun': showVideo('sun'); break;
    default: log('Neznámý token: ' + token);
  }
}

document.getElementById('connectBtn').addEventListener('click', async () => {
  if (!navigator.bluetooth) {
    statusEl.textContent = 'WebBluetooth není v tomto prohlížeči podporován.';
    log('Použij Chrome nebo Edge na desktopu / Androidu.');
    return;
  }
  await connect();
});

// manuální tlačítka (ve sloupci)
document.querySelectorAll('.controls button[data-cmd]').forEach(btn => {
  btn.addEventListener('click', () => {
    const cmd = btn.getAttribute('data-cmd');
    showVideo(cmd);
  });
});

window.addEventListener('beforeunload', () => {
  if (btDevice && btDevice.gatt.connected) btDevice.gatt.disconnect();
});
</script>
</body>
</html>
